<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>–ú–æ—ë –†–∞–¥–∏–æ</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px;
    }

    .player {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 32px 24px;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 400px;
      transition: all 0.3s ease;
    }

    .station-info { text-align: center; margin-bottom: 24px; }
    .station-name { font-size: 24px; font-weight: 700; color: #1a1a1a; margin-bottom: 8px; }
    .song-title { font-size: 18px; color: #4a5568; font-weight: 500; margin-bottom: 4px; word-break: break-word; }
    .dj-name { font-size: 14px; color: #718096; display: flex; align-items: center; justify-content: center; gap: 8px; }

    .play-button-container { display: flex; justify-content: center; margin: 32px 0; }

    .play-button {
      width: 96px;
      height: 96px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 48px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 20px 30px -10px rgba(102, 126, 234, 0.5);
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
      -webkit-tap-highlight-color: transparent;
      outline: none;
      user-select: none;
    }

    .play-button:active {
      transform: scale(0.95);
      box-shadow: 0 10px 20px -5px rgba(102, 126, 234, 0.5);
    }

    .play-button.playing {
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      box-shadow: 0 20px 30px -10px rgba(245, 101, 101, 0.5);
    }

    .volume-section {
      background: #f7fafc;
      border-radius: 24px;
      padding: 20px;
      margin: 24px 0;
    }

    .volume-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      color: #2d3748;
      font-weight: 600;
    }

    /* –í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
    .volume-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      touch-action: pan-x;
      position: relative;
      z-index: 5;
      cursor: pointer;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
      transition: transform 0.1s;
      border: 2px solid white;
    }

    .volume-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
      transition: transform 0.1s;
      border: 2px solid white;
    }

    .stats-grid { display: flex; gap: 12px; margin: 20px 0; }
    .stat-item { flex: 1; background: #f7fafc; border-radius: 16px; padding: 12px; text-align: center; }
    .stat-label { font-size: 12px; color: #718096; margin-bottom: 4px; }
    .stat-value { font-size: 18px; font-weight: 700; color: #2d3748; }

    .history-section { background: #f7fafc; border-radius: 16px; padding: 16px; margin-top: 20px; }
    .history-title { font-weight: 600; color: #2d3748; margin-bottom: 12px; font-size: 16px; }
    .history-list { list-style: none; max-height: 160px; overflow-y: auto; border-radius: 12px; }

    .history-item {
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 13px;
      color: #4a5568;
      display: flex;
      gap: 8px;
    }

    .history-item:last-child { border-bottom: none; }
    .history-time { color: #667eea; font-weight: 600; white-space: nowrap; }

    .status-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 12px;
      user-select: none;
    }

    .status-badge.playing { background: #c6f6d5; color: #22543d; }
    .status-badge.paused  { background: #fed7d7; color: #742a2a; }
    .status-badge.loading { background: #feebc8; color: #7b341e; }

    .loading { opacity: 0.7; pointer-events: none; }

    @media (max-width: 480px) {
      .player { padding: 24px 16px; }
      .play-button { width: 80px; height: 80px; font-size: 40px; }
    }
  </style>
</head>

<body>
  <div class="player" id="player">
    <div class="station-info">
      <div class="station-name" id="stationName">–†–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏—è</div>
      <div class="song-title" id="currentSong">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="dj-name">
        <span>üéß</span>
        <span id="djName">DJ</span>
        <span>‚Ä¢</span>
        <span id="bitrate">128 kbps</span>
      </div>
    </div>

    <div class="play-button-container">
      <button class="play-button" id="playBtn" aria-label="Play/Pause">‚ñ∂</button>
    </div>

    <div class="volume-section">
      <div class="volume-header">
        <span>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
        <span id="volumePercent">75%</span>
      </div>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" step="1" value="75">
    </div>

    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">–°–ª—É—à–∞—Ç–µ–ª–∏</div>
        <div class="stat-value" id="listenersCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ü–∏–∫</div>
        <div class="stat-value" id="peakListeners">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ö–∞—á–µ—Å—Ç–≤–æ</div>
        <div class="stat-value" id="quality">128</div>
      </div>
    </div>

    <div class="history-section">
      <div class="history-title">üéµ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–∫–∏</div>
      <div class="history-list" id="historyList">
        <div class="history-item">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
      </div>
    </div>

    <div id="statusBadge" class="status-badge paused">‚è∏ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
  </div>

  <script>
    (() => {
      "use strict";

      const CONFIG = {
        streamUrl: "https://myradio24.org/98353",
        apiUrl: "https://myradio24.com/users/98353/status.json",
        stationName: "–ú–æ—ë –†–∞–¥–∏–æ",
        updateInterval: 10000,
        reconnectTimeout: 3000,
        storageKey: "radioVolume"
      };

      class RadioPlayer {
        constructor() {
          // Audio element
          this.audio = new Audio();
          this.audio.preload = "none";
          this.audio.volume = 1; // –í–ê–ñ–ù–û: volume –¥–µ—Ä–∂–∏–º 1, —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ GainNode

          // WebAudio (–¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏, –≤–∫–ª—é—á–∞—è iOS)
          this.audioCtx = null;
          this.sourceNode = null;
          this.gainNode = null;

          this.isPlaying = false;
          this.isLoading = false;
          this.reconnectTimer = null;
          this.updateTimer = null;

          this.currentVolume = 75;

          this.el = {
            player: document.getElementById("player"),
            playBtn: document.getElementById("playBtn"),
            volumeSlider: document.getElementById("volumeSlider"),
            volumePercent: document.getElementById("volumePercent"),
            currentSong: document.getElementById("currentSong"),
            djName: document.getElementById("djName"),
            listenersCount: document.getElementById("listenersCount"),
            peakListeners: document.getElementById("peakListeners"),
            quality: document.getElementById("quality"),
            historyList: document.getElementById("historyList"),
            statusBadge: document.getElementById("statusBadge"),
            stationName: document.getElementById("stationName"),
            bitrate: document.getElementById("bitrate")
          };

          this.el.stationName.textContent = CONFIG.stationName;

          this.loadSettings();
          this.setupEventListeners();

          this.fetchStationInfo();
          this.startInfoUpdates();
        }

        ensureAudioGraph() {
          if (this.audioCtx) return;

          const AC = window.AudioContext || window.webkitAudioContext;
          this.audioCtx = new AC();

          // –í–∞–∂–Ω–æ: source –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —ç—Ç–æ—Ç audio-—ç–ª–µ–º–µ–Ω—Ç
          this.sourceNode = this.audioCtx.createMediaElementSource(this.audio);

          this.gainNode = this.audioCtx.createGain();
          this.gainNode.gain.value = this.currentVolume / 100;

          this.sourceNode.connect(this.gainNode);
          this.gainNode.connect(this.audioCtx.destination);
        }

        async resumeAudioContextIfNeeded() {
          if (!this.audioCtx) return;
          if (this.audioCtx.state === "suspended") {
            try { await this.audioCtx.resume(); } catch (_) {}
          }
        }

        setupEventListeners() {
          this.el.playBtn.addEventListener("click", () => this.togglePlay());

          this.el.volumeSlider.addEventListener("input", (e) => {
            this.setVolume(e.target.value);
          });

          this.el.volumeSlider.addEventListener("change", (e) => {
            const v = this.normalizeVolume(e.target.value);
            localStorage.setItem(CONFIG.storageKey, String(v));
          });

          this.audio.addEventListener("play", () => {
            this.isPlaying = true;
            this.isLoading = false;
            this.updateUI();
          });

          this.audio.addEventListener("pause", () => {
            this.isPlaying = false;
            this.isLoading = false;
            this.updateUI();
          });

          this.audio.addEventListener("waiting", () => {
            this.isLoading = true;
            this.updateUI();
          });

          this.audio.addEventListener("canplay", () => {
            this.isLoading = false;
            this.updateUI();
          });

          this.audio.addEventListener("stalled", () => {
            if (this.isPlaying) this.scheduleReconnect();
          });

          this.audio.addEventListener("error", (e) => {
            console.error("Audio error:", e);
            if (this.isPlaying) this.scheduleReconnect();
            else {
              this.isPlaying = false;
              this.isLoading = false;
              this.updateUI();
            }
          });
        }

        normalizeVolume(v) {
          const n = Number(v);
          if (!Number.isFinite(n)) return 0;
          return Math.min(100, Math.max(0, Math.round(n)));
        }

        renderVolumeUI(v) {
          this.el.volumePercent.textContent = v + "%";
          this.el.volumeSlider.style.background =
            `linear-gradient(to right, #667eea 0%, #667eea ${v}%, #e2e8f0 ${v}%, #e2e8f0 100%)`;
        }

        setVolume(v) {
          const vol = this.normalizeVolume(v);
          this.currentVolume = vol;

          this.el.volumeSlider.value = String(vol);
          this.renderVolumeUI(vol);

          // –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —á–µ—Ä–µ–∑ GainNode (—Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
          if (this.gainNode) {
            const now = this.audioCtx ? this.audioCtx.currentTime : 0;
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –±–µ–∑ —â–µ–ª—á–∫–æ–≤
            this.gainNode.gain.cancelScheduledValues(now);
            this.gainNode.gain.setValueAtTime(this.gainNode.gain.value, now);
            this.gainNode.gain.linearRampToValueAtTime(vol / 100, now + 0.03);
          }

          // mute –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –¥–æ–ø. —É–¥–æ–±—Å—Ç–≤–æ
          this.audio.muted = (vol === 0);
        }

        async togglePlay() {
          if (this.isLoading) return;

          if (this.isPlaying) {
            this.pause();
          } else {
            await this.play();
          }
        }

        async play() {
          if (this.isLoading) return;

          this.isLoading = true;
          this.updateUI();

          // –°–æ–∑–¥–∞—ë–º WebAudio-—Ü–µ–ø–æ—á–∫—É —Ç–æ–ª—å–∫–æ –ø–æ –∂–µ—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–ª–∏–∫)
          this.ensureAudioGraph();
          await this.resumeAudioContextIfNeeded();

          // –ò—Å—Ç–æ—á–Ω–∏–∫
          this.audio.src = CONFIG.streamUrl;
          this.audio.load();

          // –ü—Ä–∏–º–µ–Ω–∏–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–æ —Å—Ç–∞—Ä—Ç–∞
          this.setVolume(this.currentVolume);

          try {
            await this.audio.play();
            this.isLoading = false;
            this.isPlaying = true;
            this.updateUI();
          } catch (err) {
            console.error("Playback failed:", err);
            this.isLoading = false;
            this.isPlaying = false;
            this.updateUI();
          }
        }

        pause() {
          if (this.reconnectTimer) {
            clearTimeout(this.reconnectTimer);
            this.reconnectTimer = null;
          }

          try { this.audio.pause(); } catch (_) {}
          this.audio.src = "";
          this.audio.load();

          this.isPlaying = false;
          this.isLoading = false;
          this.updateUI();
        }

        scheduleReconnect() {
          if (this.reconnectTimer) return;

          this.reconnectTimer = setTimeout(async () => {
            this.reconnectTimer = null;
            if (!this.isPlaying) return;

            try {
              this.isLoading = true;
              this.updateUI();

              // –¥–ª—è –∫–µ—à-–æ–±—Ö–æ–¥–∞
              const url = CONFIG.streamUrl + (CONFIG.streamUrl.includes("?") ? "&" : "?") + "t=" + Date.now();

              this.audio.src = url;
              this.audio.load();

              this.ensureAudioGraph();
              await this.resumeAudioContextIfNeeded();

              this.setVolume(this.currentVolume);

              await this.audio.play();
              this.isLoading = false;
              this.isPlaying = true;
              this.updateUI();
            } catch (e) {
              this.isLoading = false;
              this.updateUI();
            }
          }, CONFIG.reconnectTimeout);
        }

        updateUI() {
          if (this.isPlaying) {
            this.el.playBtn.innerHTML = "‚è∏";
            this.el.playBtn.classList.add("playing");
          } else {
            this.el.playBtn.innerHTML = "‚ñ∂";
            this.el.playBtn.classList.remove("playing");
          }

          if (this.isLoading) {
            this.el.playBtn.style.opacity = "0.7";
            this.el.statusBadge.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            this.el.statusBadge.className = "status-badge loading";
            this.el.player.classList.add("loading");
          } else {
            this.el.playBtn.style.opacity = "1";
            this.el.player.classList.remove("loading");

            if (this.isPlaying) {
              this.el.statusBadge.textContent = "üîä –í —ç—Ñ–∏—Ä–µ";
              this.el.statusBadge.className = "status-badge playing";
            } else {
              this.el.statusBadge.textContent = "‚è∏ –ü–∞—É–∑–∞";
              this.el.statusBadge.className = "status-badge paused";
            }
          }
        }

        async fetchStationInfo() {
          try {
            const res = await fetch(CONFIG.apiUrl, { method: "GET", mode: "cors", cache: "no-cache" });
            if (!res.ok) throw new Error("Network error: " + res.status);
            const data = await res.json();

            if (data.song) this.el.currentSong.textContent = data.song;
            if (data.djname) this.el.djName.textContent = data.djname;

            if (data.listeners !== undefined) this.el.listenersCount.textContent = String(data.listeners);
            if (data.plisteners !== undefined) this.el.peakListeners.textContent = String(data.plisteners);

            if (data.kbps !== undefined) {
              this.el.quality.textContent = String(data.kbps);
              this.el.bitrate.textContent = String(data.kbps) + " kbps";
            }

            if (data.songs && Array.isArray(data.songs)) this.updateHistory(data.songs);
          } catch (e) {
            console.error("Failed to fetch station info:", e);
          }
        }

        updateHistory(songs) {
          if (!songs || songs.length === 0) {
            this.el.historyList.innerHTML = '<div class="history-item">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
          }

          const esc = (s) => String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");

          this.el.historyList.innerHTML = songs.slice(0, 10).map(song => {
            const time = Array.isArray(song) ? (song[0] || "") : (song.time || "");
            const title = Array.isArray(song) ? (song[1] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") : (song.song || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");
            return `
              <div class="history-item">
                <span class="history-time">${esc(time)}</span>
                <span>${esc(title)}</span>
              </div>
            `;
          }).join("");
        }

        startInfoUpdates() {
          if (this.updateTimer) clearInterval(this.updateTimer);
          this.updateTimer = setInterval(() => this.fetchStationInfo(), CONFIG.updateInterval);
        }

        loadSettings() {
          const saved = localStorage.getItem(CONFIG.storageKey);
          const v = saved !== null ? this.normalizeVolume(saved) : 75;
          this.currentVolume = v;
          this.el.volumeSlider.value = String(v);
          this.renderVolumeUI(v);
          this.audio.muted = (v === 0);
        }
      }

      const boot = () => { window.radioPlayer = new RadioPlayer(); };

      if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
      else boot();
    })();
  </script>
</body>
</html>
