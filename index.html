<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>–ú–æ—ë –†–∞–¥–∏–æ</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
      display:flex; justify-content:center; align-items:center;
      min-height:100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding:16px;
    }

    .player{
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 32px 24px;
      border-radius: 32px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      width:100%;
      max-width:400px;
      transition: all .3s ease;
    }

    .station-info{ text-align:center; margin-bottom:24px; }
    .station-name{ font-size:24px; font-weight:700; color:#1a1a1a; margin-bottom:8px; }
    .song-title{ font-size:18px; color:#4a5568; font-weight:500; margin-bottom:4px; word-break:break-word; }
    .dj-name{ font-size:14px; color:#718096; display:flex; align-items:center; justify-content:center; gap:8px; }

    .play-button-container{ display:flex; justify-content:center; margin: 32px 0; }

    .play-button{
      width:96px; height:96px; border-radius:50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border:none; color:#fff; font-size:48px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      box-shadow: 0 20px 30px -10px rgba(102,126,234,0.5);
      transition: transform .2s, box-shadow .2s, opacity .2s;
      -webkit-tap-highlight-color: transparent;
      outline:none;
      user-select:none;
    }
    .play-button:active{ transform: scale(0.95); box-shadow: 0 10px 20px -5px rgba(102,126,234,0.5); }
    .play-button.playing{
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      box-shadow: 0 20px 30px -10px rgba(245,101,101,0.5);
    }

    .volume-section{
      background:#f7fafc;
      border-radius:24px;
      padding:20px;
      margin:24px 0;
    }
    .volume-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:12px; color:#2d3748; font-weight:600;
    }

    /* –í–ê–ñ–ù–û: touch-action + z-index ‚Äî —Ñ–∏–∫—Å –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
    .volume-slider{
      width:100%;
      height:8px;
      border-radius:4px;
      background:#e2e8f0;
      outline:none;
      -webkit-appearance:none;
      appearance:none;

      touch-action: pan-x;
      position: relative;
      z-index: 5;
      cursor: pointer;
    }
    .volume-slider::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:24px; height:24px;
      border-radius:50%;
      background:#667eea;
      box-shadow: 0 2px 6px rgba(102,126,234,0.4);
      border:2px solid #fff;
      transition: transform .1s;
    }
    .volume-slider::-webkit-slider-thumb:hover{ transform: scale(1.1); }

    .volume-slider::-moz-range-thumb{
      width:24px; height:24px;
      border-radius:50%;
      background:#667eea;
      box-shadow: 0 2px 6px rgba(102,126,234,0.4);
      border:2px solid #fff;
      transition: transform .1s;
    }

    .stats-grid{ display:flex; gap:12px; margin:20px 0; }
    .stat-item{ flex:1; background:#f7fafc; border-radius:16px; padding:12px; text-align:center; }
    .stat-label{ font-size:12px; color:#718096; margin-bottom:4px; }
    .stat-value{ font-size:18px; font-weight:700; color:#2d3748; }

    .history-section{ background:#f7fafc; border-radius:16px; padding:16px; margin-top:20px; }
    .history-title{ font-weight:600; color:#2d3748; margin-bottom:12px; font-size:16px; }
    .history-list{ list-style:none; max-height:160px; overflow-y:auto; border-radius:12px; }
    .history-item{
      padding:10px; border-bottom:1px solid #e2e8f0;
      font-size:13px; color:#4a5568;
      display:flex; gap:8px;
    }
    .history-item:last-child{ border-bottom:none; }
    .history-time{ color:#667eea; font-weight:600; white-space:nowrap; }

    .status-badge{
      display:inline-block;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:600;
      margin-top:12px;
      user-select:none;
    }
    .status-badge.playing{ background:#c6f6d5; color:#22543d; }
    .status-badge.paused{ background:#fed7d7; color:#742a2a; }
    .status-badge.loading{ background:#feebc8; color:#7b341e; }

    .loading{
      opacity:0.7;
      pointer-events:none;
    }

    @media (max-width:480px){
      .player{ padding:24px 16px; }
      .play-button{ width:80px; height:80px; font-size:40px; }
    }
  </style>
</head>

<body>
  <div class="player" id="player">
    <div class="station-info">
      <div class="station-name" id="stationName">–†–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏—è</div>
      <div class="song-title" id="currentSong">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      <div class="dj-name" id="djInfo">
        <span>üéß</span>
        <span id="djName">DJ</span>
        <span>‚Ä¢</span>
        <span id="bitrate">128 kbps</span>
      </div>
    </div>

    <div class="play-button-container">
      <button class="play-button" id="playBtn" aria-label="Play/Pause">‚ñ∂</button>
    </div>

    <div class="volume-section">
      <div class="volume-header">
        <span>üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å</span>
        <span id="volumePercent">75%</span>
      </div>
      <input
        type="range"
        class="volume-slider"
        id="volumeSlider"
        min="0"
        max="100"
        step="1"
        value="75"
        aria-label="Volume"
      />
    </div>

    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">–°–ª—É—à–∞—Ç–µ–ª–∏</div>
        <div class="stat-value" id="listenersCount">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ü–∏–∫</div>
        <div class="stat-value" id="peakListeners">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">–ö–∞—á–µ—Å—Ç–≤–æ</div>
        <div class="stat-value" id="quality">128</div>
      </div>
    </div>

    <div class="history-section">
      <div class="history-title">üéµ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–∫–∏</div>
      <div class="history-list" id="historyList">
        <div class="history-item">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</div>
      </div>
    </div>

    <div id="statusBadge" class="status-badge paused">‚è∏ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
  </div>

  <script>
    (() => {
      "use strict";

      const CONFIG = {
        streamUrl: "https://myradio24.org/98353",
        apiUrl: "https://myradio24.com/users/98353/status.json",
        stationName: "–ú–æ—ë –†–∞–¥–∏–æ",
        updateInterval: 10000,
        reconnectTimeout: 3000,
        storageKey: "radioVolume"
      };

      class RadioPlayer {
        constructor() {
          this.audio = new Audio();
          this.audio.preload = "none";

          this.isPlaying = false;
          this.isLoading = false;
          this.reconnectTimer = null;
          this.updateTimer = null;

          this.currentVolume = 75;

          this.elements = {
            playBtn: document.getElementById("playBtn"),
            volumeSlider: document.getElementById("volumeSlider"),
            volumePercent: document.getElementById("volumePercent"),
            currentSong: document.getElementById("currentSong"),
            djName: document.getElementById("djName"),
            listenersCount: document.getElementById("listenersCount"),
            peakListeners: document.getElementById("peakListeners"),
            quality: document.getElementById("quality"),
            historyList: document.getElementById("historyList"),
            statusBadge: document.getElementById("statusBadge"),
            stationName: document.getElementById("stationName"),
            bitrate: document.getElementById("bitrate"),
            player: document.getElementById("player")
          };

          this.elements.stationName.textContent = CONFIG.stationName;

          this.loadSettings();
          this.setupEventListeners();

          this.fetchStationInfo();
          this.startInfoUpdates();
        }

        setupEventListeners() {
          // Play/Pause
          this.elements.playBtn.addEventListener("click", () => this.togglePlay());

          // Volume slider (input = live)
          this.elements.volumeSlider.addEventListener("input", (e) => {
            this.setVolume(e.target.value);
          });

          // Save volume when user finishes dragging
          this.elements.volumeSlider.addEventListener("change", (e) => {
            const v = this.normalizeVolume(e.target.value);
            localStorage.setItem(CONFIG.storageKey, String(v));
          });

          // Audio events
          this.audio.addEventListener("play", () => {
            this.isPlaying = true;
            this.isLoading = false;
            this.updateUI();
          });

          this.audio.addEventListener("pause", () => {
            this.isPlaying = false;
            this.isLoading = false;
            this.updateUI();
          });

          this.audio.addEventListener("waiting", () => {
            this.isLoading = true;
            this.updateUI();
          });

          this.audio.addEventListener("canplay", () => {
            this.isLoading = false;
            // Safari/iOS –∏–Ω–æ–≥–¥–∞ ‚Äú—Å—ä–µ–¥–∞–µ—Ç‚Äù –≥—Ä–æ–º–∫–æ—Å—Ç—å ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –µ—â—ë —Ä–∞–∑
            this.applyVolumeToAudio();
            this.updateUI();
          });

          this.audio.addEventListener("loadedmetadata", () => {
            this.applyVolumeToAudio();
          });

          this.audio.addEventListener("stalled", () => {
            if (this.isPlaying) this.scheduleReconnect();
          });

          this.audio.addEventListener("error", (e) => {
            console.error("Audio error:", e);
            if (this.isPlaying) {
              this.scheduleReconnect();
            } else {
              this.isPlaying = false;
              this.isLoading = false;
              this.updateUI();
            }
          });

          // If browser changes volume internally, keep UI in sync
          this.audio.addEventListener("volumechange", () => {
            // Protect from loops: only sync if differs meaningfully
            const v = Math.round((this.audio.volume || 0) * 100);
            if (Number.isFinite(v) && v !== this.currentVolume) {
              this.currentVolume = v;
              this.elements.volumeSlider.value = String(v);
              this.renderVolumeUI(v);
            }
          });
        }

        normalizeVolume(value) {
          const n = Number(value);
          if (!Number.isFinite(n)) return 0;
          return Math.min(100, Math.max(0, Math.round(n)));
        }

        renderVolumeUI(v) {
          this.elements.volumePercent.textContent = v + "%";
          this.elements.volumeSlider.style.background =
            `linear-gradient(to right, #667eea 0%, #667eea ${v}%, #e2e8f0 ${v}%, #e2e8f0 100%)`;
        }

        applyVolumeToAudio() {
          if (!this.audio) return;
          this.audio.volume = this.currentVolume / 100;
          this.audio.muted = (this.currentVolume === 0);
        }

        setVolume(value) {
          const v = this.normalizeVolume(value);
          this.currentVolume = v;
          this.renderVolumeUI(v);
          this.applyVolumeToAudio();
        }

        togglePlay() {
          if (this.isLoading) return;
          if (this.isPlaying) this.pause();
          else this.play();
        }

        play() {
          if (this.isLoading) return;

          this.isLoading = true;
          this.updateUI();

          // (Re)assign source and start
          this.audio.src = CONFIG.streamUrl;
          this.audio.load();

          // Apply volume right before play (–≤–∞–∂–Ω–æ –¥–ª—è iOS/Safari)
          this.applyVolumeToAudio();

          const p = this.audio.play();
          if (p && typeof p.then === "function") {
            p.then(() => {
              this.isLoading = false;
              this.isPlaying = true;
              // Safari/iOS ‚Äî –µ—â—ë —Ä–∞–∑ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞
              this.applyVolumeToAudio();
              this.updateUI();
            }).catch((err) => {
              console.error("Playback failed:", err);
              this.isPlaying = false;
              this.isLoading = false;
              this.updateUI();
            });
          }
        }

        pause() {
          if (this.reconnectTimer) {
            clearTimeout(this.reconnectTimer);
            this.reconnectTimer = null;
          }

          try { this.audio.pause(); } catch (_) {}

          // Reset source to stop stream
          this.audio.src = "";
          this.audio.load();

          this.isPlaying = false;
          this.isLoading = false;
          this.updateUI();
        }

        scheduleReconnect() {
          if (this.reconnectTimer) return;

          this.reconnectTimer = setTimeout(() => {
            this.reconnectTimer = null;
            if (!this.isPlaying) return;

            console.log("Reconnecting...");
            this.isLoading = true;
            this.updateUI();

            this.audio.src = CONFIG.streamUrl + (CONFIG.streamUrl.includes("?") ? "&" : "?") + "t=" + Date.now();
            this.audio.load();
            this.applyVolumeToAudio();

            this.audio.play().then(() => {
              this.isLoading = false;
              this.isPlaying = true;
              this.applyVolumeToAudio();
              this.updateUI();
            }).catch(() => {
              this.isLoading = false;
              this.updateUI();
            });
          }, CONFIG.reconnectTimeout);
        }

        updateUI() {
          // Button state
          if (this.isPlaying) {
            this.elements.playBtn.innerHTML = "‚è∏";
            this.elements.playBtn.classList.add("playing");
          } else {
            this.elements.playBtn.innerHTML = "‚ñ∂";
            this.elements.playBtn.classList.remove("playing");
          }

          // Loading / badge
          if (this.isLoading) {
            this.elements.playBtn.style.opacity = "0.7";
            this.elements.statusBadge.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            this.elements.statusBadge.className = "status-badge loading";
            this.elements.player.classList.add("loading");
          } else {
            this.elements.playBtn.style.opacity = "1";
            this.elements.player.classList.remove("loading");

            if (this.isPlaying) {
              this.elements.statusBadge.textContent = "üîä –í —ç—Ñ–∏—Ä–µ";
              this.elements.statusBadge.className = "status-badge playing";
            } else {
              this.elements.statusBadge.textContent = "‚è∏ –ü–∞—É–∑–∞";
              this.elements.statusBadge.className = "status-badge paused";
            }
          }
        }

        async fetchStationInfo() {
          try {
            const res = await fetch(CONFIG.apiUrl, {
              method: "GET",
              mode: "cors",
              cache: "no-cache"
            });
            if (!res.ok) throw new Error("Network error: " + res.status);

            const data = await res.json();

            if (data.song) this.elements.currentSong.textContent = data.song;
            if (data.djname) this.elements.djName.textContent = data.djname;

            if (data.listeners !== undefined) this.elements.listenersCount.textContent = String(data.listeners);
            if (data.plisteners !== undefined) this.elements.peakListeners.textContent = String(data.plisteners);

            if (data.kbps !== undefined) {
              this.elements.quality.textContent = String(data.kbps);
              this.elements.bitrate.textContent = String(data.kbps) + " kbps";
            }

            if (data.songs && Array.isArray(data.songs)) this.updateHistory(data.songs);
          } catch (err) {
            console.error("Failed to fetch station info:", err);
          }
        }

        updateHistory(songs) {
          if (!songs || songs.length === 0) {
            this.elements.historyList.innerHTML = '<div class="history-item">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
          }

          const html = songs.slice(0, 10).map((song) => {
            const time = Array.isArray(song) ? (song[0] || "") : (song.time || "");
            const title = Array.isArray(song) ? (song[1] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") : (song.song || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ");

            return `
              <div class="history-item">
                <span class="history-time">${this.escapeHtml(String(time))}</span>
                <span>${this.escapeHtml(String(title))}</span>
              </div>
            `;
          }).join("");

          this.elements.historyList.innerHTML = html;
        }

        escapeHtml(str) {
          return str
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#039;");
        }

        startInfoUpdates() {
          if (this.updateTimer) clearInterval(this.updateTimer);
          this.updateTimer = setInterval(() => this.fetchStationInfo(), CONFIG.updateInterval);
        }

        loadSettings() {
          const saved = localStorage.getItem(CONFIG.storageKey);
          const v = saved !== null ? this.normalizeVolume(saved) : 75;

          this.currentVolume = v;
          this.elements.volumeSlider.value = String(v);
          this.renderVolumeUI(v);
          this.applyVolumeToAudio();
        }
      }

      const boot = () => { window.radioPlayer = new RadioPlayer(); };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    })();
  </script>
</body>
</html>
